# Findings on Heatpump Monitoring Plan

## 1. Token Persistence (Critical)

The plan mentions storing credentials in `.env`, but does not explicitly state that the **OAuth token cache** (generated by PyViCare, typically `token.save`) should be persisted.

- **Risk**: If the backend container restarts, a new login flow is initiated. Frequent restarts could trigger Viessmann's security blocks or rate limits for authentication.
- **Recommendation**: Mount a Docker volume for the backend service to persist the `token.save` file (e.g., `/app/data/token.save`).

## 2. InfluxDB Initialization

The plan mentions "spin up InfluxDB" but lacks details on automated provisioning.

- **Recommendation**: Use InfluxDB's initialization environment variables (`DOCKER_INFLUXDB_INIT_MODE=setup`, `DOCKER_INFLUXDB_INIT_USERNAME`, `DOCKER_INFLUXDB_INIT_BUCKET`, etc.) in `docker-compose.yml`. This ensures the `heatpump_raw` bucket and authentication tokens exist automatically on the first run, making deployment reproducible.

## 3. Runtime Counter Resolution

The JAZ calculation relies on `heating.compressors.0.statistics` (Property `hours`) to detect runtime fraction within a 5-minute interval.

- **Potential Issue**: On many Viessmann controllers, the operating hours counter is an **integer**. If the API returns `1234` hours and not `1234.56`, the delta between 5-minute polls will mostly be `0`, and occasionally jump by `1`.
- **Impact**: This would make 5-minute energy calculations impossible using this method.
- **Recommendation**: Verify the precision of the `hours` property. If it is an integer, the "Runtime Fraction" logic for 5-minute intervals must be abandoned or replaced with a simple "Is Active?" boolean check (sampled instantaneously), which is less accurate but feasible. Alternatively, JAZ should only be calculated on a Daily basis where integer resolution is acceptable.

## 4. Alerting System

The plan focuses on "Monitoring" (visualization) but misses "Alerting".

- **Recommendation**: Add a simple alerting mechanism (e.g., via Apprise, Telegram, or email) for:
  - **Critical Faults**: Heat pump reports an error code.
  - **Data Staleness**: No data from Viessmann or Shelly for > 1 hour.
  - **Efficiency Drops**: COP significantly below expected range for sustained period.

## 5. Frontend Polling & Real-time Experience

The plan aligns backend polling (5m) with Viessmann limits. However, Shelly data is available every 10s.

- **Recommendation**: The Frontend should poll the API (or use Server-Sent Events) more frequently than 5 minutes (e.g., every 30s) to reflect the "Live" Shelly power consumption, even if the thermal data updates slower. This makes the dashboard feel "alive".

## 6. Docker Healthchecks

- **Recommendation**: Define `healthcheck` in `docker-compose.yml` for InfluxDB. Configure the Backend container to `depends_on` InfluxDB with `condition: service_healthy` to prevent startup crashes when the database isn't ready.

## 7. Architecture Support

- **Recommendation**: Ensure the Docker images specified (especially for InfluxDB and Python base images) support the target architecture (e.g., `linux/arm64` if running on Raspberry Pi, `linux/amd64` for standard servers).
